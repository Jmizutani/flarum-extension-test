(()=>{var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var i in r)e.o(r,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:r[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};(()=>{"use strict";const t=flarum.core.compat["forum/app"];var r=e.n(t);function i(e,t){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},i(e,t)}function n(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,i(e,t)}const o=flarum.core.compat["common/Model"];var s=e.n(o),a=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),n=0;n<r;n++)i[n]=arguments[n];return(t=e.call.apply(e,[this].concat(i))||this).userId=s().attribute("userId"),t.facebookUrl=s().attribute("facebookUrl"),t.xUrl=s().attribute("xUrl"),t.instagramUrl=s().attribute("instagramUrl"),t.isVisible=s().attribute("isVisible"),t.customFields=s().attribute("customFields"),t.createdAt=s().attribute("createdAt",s().transformDate),t.updatedAt=s().attribute("updatedAt",s().transformDate),t.user=s().hasOne("user"),t}return n(t,e),t}(s()),l=function(e){function t(){for(var t,r=arguments.length,i=new Array(r),n=0;n<r;n++)i[n]=arguments[n];return(t=e.call.apply(e,[this].concat(i))||this).name=s().attribute("name"),t.label=s().attribute("label"),t.type=s().attribute("type"),t.placeholder=s().attribute("placeholder"),t.required=s().attribute("required"),t.sortOrder=s().attribute("sortOrder"),t.isActive=s().attribute("isActive"),t.createdAt=s().attribute("createdAt",s().transformDate),t.updatedAt=s().attribute("updatedAt",s().transformDate),t}return n(t,e),t}(s()),c=function(e){function t(){return e.apply(this,arguments)||this}return n(t,e),t}(s());Object.assign(c.prototype,{name:s().attribute("name"),label:s().attribute("label"),iconUrl:s().attribute("iconUrl"),placeholder:s().attribute("placeholder"),sortOrder:s().attribute("sortOrder"),isActive:s().attribute("isActive"),createdAt:s().attribute("createdAt"),updatedAt:s().attribute("updatedAt")});const u=flarum.core.compat["common/Component"];var d=e.n(u);const f=flarum.core.compat["common/components/Button"];var p=e.n(f);function h(){return h=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)({}).hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e},h.apply(null,arguments)}const b=flarum.core.compat["common/components/Modal"];var v=e.n(b);const g=flarum.core.compat["common/components/Switch"];var y=e.n(g);const k=flarum.core.compat["common/utils/Stream"];var U=e.n(k);function F(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return L(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?L(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function L(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=Array(t);r<t;r++)i[r]=e[r];return i}var N=function(e){function t(){return e.apply(this,arguments)||this}n(t,e);var r=t.prototype;return r.oninit=function(t){e.prototype.oninit.call(this,t),this.focusableElements=[],this.firstFocusableElement=null,this.lastFocusableElement=null;var r=this.attrs.profile||{},i="function"==typeof r.facebookUrl?r.facebookUrl():r.facebookUrl,n="function"==typeof r.xUrl?r.xUrl():r.xUrl,o="function"==typeof r.instagramUrl?r.instagramUrl():r.instagramUrl,s="function"==typeof r.isVisible?r.isVisible():r.isVisible,a="function"==typeof r.customFields?r.customFields():r.customFields;this.facebookUrl=U()(i||""),this.xUrl=U()(n||""),this.instagramUrl=U()(o||""),this.isVisible=U()(void 0===s||s),this.loading=!1,this.fieldsLoading=!0,this.socialLinksLoading=!0,this.fields=[],this.socialLinks=[],this.customFields={},a&&(this.customFields=h({},a)),this.loadFields(),this.loadSocialLinks()},r.loadFields=function(){var e=this;app.store.find("profile-fields").then(function(t){e.fields=t.sort(function(e,t){return e.sortOrder()-t.sortOrder()}),e.fields.forEach(function(t){e.customFields[t.name()]?e.customFields[t.name()]=U()(e.customFields[t.name()]):e.customFields[t.name()]=U()("")}),e.fieldsLoading=!1,m.redraw()}).catch(function(){e.fieldsLoading=!1,m.redraw()})},r.loadSocialLinks=function(){var e=this;app.store.find("social-links").then(function(t){e.socialLinks=t.filter(function(e){return e.isActive()}).sort(function(e,t){return e.sortOrder()-t.sortOrder()}),e.socialLinksLoading=!1,m.redraw()}).catch(function(t){console.error("ソーシャルリンクの読み込みに失敗しました:",t),e.socialLinks=e.getDefaultSocialLinks(),e.socialLinksLoading=!1,m.redraw()})},r.getDefaultSocialLinks=function(){return[{name:function(){return"facebook"},label:function(){return"Facebook URL"},placeholder:function(){return"https://facebook.com/username"}},{name:function(){return"x"},label:function(){return"X (Twitter) URL"},placeholder:function(){return"https://x.com/username"}},{name:function(){return"instagram"},label:function(){return"Instagram URL"},placeholder:function(){return"https://instagram.com/username"}}]},r.className=function(){return"UserProfileModal Modal--large"},r.oncreate=function(t){e.prototype.oncreate.call(this,t),this.setupFocusManagement()},r.setupFocusManagement=function(){var e=this,t=this.element;t&&(this.focusableElements=t.querySelectorAll('input, textarea, button, select, [tabindex]:not([tabindex="-1"])'),this.focusableElements.length>0&&(this.firstFocusableElement=this.focusableElements[0],this.lastFocusableElement=this.focusableElements[this.focusableElements.length-1],setTimeout(function(){e.firstFocusableElement&&e.firstFocusableElement.focus()},100)))},r.onkeydown=function(e){var t,r;"Tab"===e.key&&(e.shiftKey?document.activeElement===this.firstFocusableElement&&(e.preventDefault(),null==(t=this.lastFocusableElement)||t.focus()):document.activeElement===this.lastFocusableElement&&(e.preventDefault(),null==(r=this.firstFocusableElement)||r.focus())),"Escape"===e.key&&(e.preventDefault(),this.hide())},r.title=function(){return"プロフィール編集"},r.content=function(){var e=this;return this.fieldsLoading?m("div",{className:"Modal-body"},m("div",{className:"LoadingIndicator"})):m("div",{className:"Modal-body",role:"dialog","aria-labelledby":"modal-title","aria-describedby":"modal-description",onkeydown:this.onkeydown.bind(this)},m("div",{className:"Form"},this.fields.map(function(t){return e.renderCustomField(t)}),m("div",{className:"Form-group"},m("h4",null,"ソーシャルリンク")),this.socialLinksLoading?m("div",{className:"LoadingIndicator"},"読み込み中..."):this.socialLinks.map(function(t){var r,i=t.name();return"facebook"===i?r=e.facebookUrl:"x"===i?r=e.xUrl:"instagram"===i?r=e.instagramUrl:(e[i+"Url"]||(e[i+"Url"]=U()("")),r=e[i+"Url"]),m("div",{key:i,className:"Form-group"},m("label",null,t.label()),m("input",{className:"FormControl",type:"url",value:r(),oninput:function(e){return r(e.target.value)},placeholder:t.placeholder()}))}),m("div",{className:"Form-group"},m(y(),{state:this.isVisible(),onchange:this.isVisible},"プロフィールを他のユーザーに公開する")),m("div",{className:"Form-group"},m(p(),{className:"Button Button--primary",type:"submit",loading:this.loading,tabindex:"0"},"保存"),m(p(),{className:"Button Button--default",onclick:this.hide.bind(this),tabindex:"0"},"キャンセル"))))},r.renderCustomField=function(e){var t=this.customFields[e.name()];return t?m("div",{key:e.id(),className:"Form-group"},m("label",null,e.label(),e.required()&&m("span",{className:"required"},"*")),"textarea"===e.type()?m("textarea",{className:"FormControl",value:t(),oninput:function(e){return t(e.target.value)},rows:"4",placeholder:e.placeholder()||e.label()+"を入力してください",required:e.required()}):m("input",{className:"FormControl",type:"text",value:t(),oninput:function(e){return t(e.target.value)},placeholder:e.placeholder()||e.label()+"を入力してください",required:e.required()})):null},r.onsubmit=function(e){var t=this;e.preventDefault();for(var r,i=F(this.fields);!(r=i()).done;){var n=r.value;if(n.required()&&n.isActive()){var o=this.customFields[n.name()];if(!o||!o().trim())return void alert(n.label()+"は必須項目です。")}}this.loading=!0,m.redraw();for(var s,a={},l=F(this.fields);!(s=l()).done;){var c=s.value,u=this.customFields[c.name()];u&&(a[c.name()]=u())}var d={userId:app.session.user.id(),facebookUrl:this.facebookUrl(),xUrl:this.xUrl(),instagramUrl:this.instagramUrl(),isVisible:this.isVisible(),customFields:a};app.store.createRecord("user-profiles").save(d).then(function(e){app.store.pushObject(e),t.attrs.onSave&&t.attrs.onSave(e),t.hide(),m.redraw()}).catch(function(){t.loading=!1,m.redraw()})},t}(v()),A=function(e){function t(){return e.apply(this,arguments)||this}n(t,e);var r=t.prototype;return r.oninit=function(t){e.prototype.oninit.call(this,t),this.user=this.attrs.user,this.profile=null,this.fields=[],this.socialLinks=[],this.loading=!0,this.fieldsLoading=!0,this.socialLinksLoading=!0,this.loadProfile(),this.loadFields(),this.loadSocialLinks()},r.loadProfile=function(){var e=this;app.store.find("user-profiles",{userId:this.user.id()}).then(function(t){e.profile=t,e.loading=!1,m.redraw()}).catch(function(){e.loading=!1,m.redraw()})},r.loadFields=function(){var e=this;app.store.find("profile-fields").then(function(t){e.fields=t.sort(function(e,t){return e.sortOrder()-t.sortOrder()}),e.fieldsLoading=!1,m.redraw()}).catch(function(){e.fieldsLoading=!1,m.redraw()})},r.loadSocialLinks=function(){var e=this;app.store.find("social-links").then(function(t){e.socialLinks=t.sort(function(e,t){return e.sortOrder()-t.sortOrder()}),e.socialLinksLoading=!1,m.redraw()}).catch(function(){e.socialLinksLoading=!1,m.redraw()})},r.refreshProfile=function(e){this.profile=e,m.redraw()},r.view=function(){var e=this;if(this.loading||this.fieldsLoading||this.socialLinksLoading)return m("div",{className:"UserProfileWidget"},"読み込み中...");var t=app.session.user&&app.session.user.id()===this.user.id(),r=this.profile&&(this.profile.isVisible()||t||app.session.user&&app.session.user.isAdmin());return m("div",{className:"UserProfileWidget"},m("div",{className:"UserProfileWidget-header"},m("h3",null,"プロフィール"),t&&m(p(),{className:"Button Button--primary Button--small",onclick:function(){return app.modal.show(N,{profile:e.profile,onSave:function(t){return e.refreshProfile(t)}})}},"編集")),r&&this.profile?m("div",{className:"UserProfileWidget-content"},this.renderCustomFields(),this.renderSocialLinks(),!this.profile.isVisible()&&t&&m("div",{className:"UserProfileWidget-section"},m("em",null,"このプロフィールは非公開に設定されています。"))):m("div",{className:"UserProfileWidget-content"},t?m("div",{className:"UserProfileWidget-empty"},m("p",null,"プロフィールが設定されていません。"),m(p(),{className:"Button Button--primary",onclick:function(){return app.modal.show(N,{profile:null,onSave:function(t){return e.refreshProfile(t)}})}},"プロフィールを作成")):m("div",{className:"UserProfileWidget-empty"},m("p",null,"プロフィールは非公開に設定されています。"))))},r.renderCustomFields=function(){if(!this.profile||!this.profile.customFields)return null;var e=this.profile.customFields();return this.fields.filter(function(t){return t.isActive()&&e&&e[t.name()]}).map(function(t){return m("div",{key:t.id(),className:"UserProfileWidget-section"},m("h4",null,t.label()),m("p",null,e[t.name()]))})},r.renderSocialLinks=function(){if(!this.profile)return null;var e={facebook:this.profile.facebookUrl(),x:this.profile.xUrl(),instagram:this.profile.instagramUrl()};return Object.values(e).some(function(e){return e})?m("div",{className:"UserProfileWidget-section"},m("h4",null,"ソーシャルリンク"),m("div",{className:"UserProfileWidget-socialLinks"},this.socialLinks.filter(function(t){return e[t.name()]&&t.isActive()}).map(function(t){var r=e[t.name()];return m("a",{key:t.id(),href:r,target:"_blank",rel:"noopener noreferrer",className:"UserProfileWidget-socialLink",title:t.label()},m("img",{src:t.iconUrl(),alt:t.label(),className:"UserProfileWidget-socialIcon"}))}))):null},t}(d());const w=flarum.core.compat["common/extend"],O=flarum.core.compat["forum/components/UserPage"];var x=e.n(O);r().initializers.add("junya-user-profile",function(){r().store.models["user-profiles"]=a,r().store.models["profile-fields"]=l,r().store.models["social-links"]=c,(0,w.extend)(x().prototype,"sidebarItems",function(e){e.add("userProfile",m(A,{user:this.user}),10)})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map