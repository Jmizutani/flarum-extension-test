(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var i in r)t.o(r,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:r[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.core.compat["forum/app"];var r=t.n(e);function i(t,e){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},i(t,e)}function o(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,i(t,e)}const n=flarum.core.compat["common/Model"];var a=t.n(n),s=function(t){function e(){for(var e,r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return(e=t.call.apply(t,[this].concat(i))||this).userId=a().attribute("userId"),e.facebookUrl=a().attribute("facebookUrl"),e.xUrl=a().attribute("xUrl"),e.instagramUrl=a().attribute("instagramUrl"),e.isVisible=a().attribute("isVisible"),e.customFields=a().attribute("customFields"),e.createdAt=a().attribute("createdAt",a().transformDate),e.updatedAt=a().attribute("updatedAt",a().transformDate),e.user=a().hasOne("user"),e}return o(e,t),e}(a()),l=function(t){function e(){for(var e,r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];return(e=t.call.apply(t,[this].concat(i))||this).name=a().attribute("name"),e.label=a().attribute("label"),e.type=a().attribute("type"),e.required=a().attribute("required"),e.sortOrder=a().attribute("sortOrder"),e.isActive=a().attribute("isActive"),e.createdAt=a().attribute("createdAt",a().transformDate),e.updatedAt=a().attribute("updatedAt",a().transformDate),e}return o(e,t),e}(a()),u=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e}(a());Object.assign(u.prototype,{name:a().attribute("name"),label:a().attribute("label"),iconUrl:a().attribute("iconUrl"),urlPattern:a().attribute("urlPattern"),sortOrder:a().attribute("sortOrder"),isActive:a().attribute("isActive"),createdAt:a().attribute("createdAt"),updatedAt:a().attribute("updatedAt")});const c=flarum.core.compat["common/Component"];var d=t.n(c);const f=flarum.core.compat["common/components/Button"];var p=t.n(f);function h(){return h=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)({}).hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t},h.apply(null,arguments)}const v=flarum.core.compat["common/components/Modal"];var b=t.n(v);const g=flarum.core.compat["common/components/Switch"];var y=t.n(g);const U=flarum.core.compat["common/utils/Stream"];var F=t.n(U);function k(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(r)return(r=r.call(t)).next.bind(r);if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return N(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?N(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var i=0;return function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function N(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,i=Array(e);r<e;r++)i[r]=t[r];return i}var L=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var r=e.prototype;return r.oninit=function(e){t.prototype.oninit.call(this,e);var r=this.attrs.profile||{},i="function"==typeof r.facebookUrl?r.facebookUrl():r.facebookUrl,o="function"==typeof r.xUrl?r.xUrl():r.xUrl,n="function"==typeof r.instagramUrl?r.instagramUrl():r.instagramUrl,a="function"==typeof r.isVisible?r.isVisible():r.isVisible,s="function"==typeof r.customFields?r.customFields():r.customFields;this.facebookUrl=F()(i||""),this.xUrl=F()(o||""),this.instagramUrl=F()(n||""),this.isVisible=F()(void 0===a||a),this.loading=!1,this.fieldsLoading=!0,this.fields=[],this.customFields={},s&&(this.customFields=h({},s)),this.loadFields()},r.loadFields=function(){var t=this;app.store.find("profile-fields").then(function(e){t.fields=e.sort(function(t,e){return t.sortOrder()-e.sortOrder()}),t.fields.forEach(function(e){t.customFields[e.name()]?t.customFields[e.name()]=F()(t.customFields[e.name()]):t.customFields[e.name()]=F()("")}),t.fieldsLoading=!1,m.redraw()}).catch(function(){t.fieldsLoading=!1,m.redraw()})},r.className=function(){return"UserProfileModal Modal--large"},r.title=function(){return"プロフィール編集"},r.content=function(){var t=this;return this.fieldsLoading?m("div",{className:"Modal-body"},m("div",{className:"LoadingIndicator"})):m("div",{className:"Modal-body"},m("div",{className:"Form"},this.fields.map(function(e){return t.renderCustomField(e)}),m("div",{className:"Form-group"},m("h4",null,"ソーシャルリンク")),m("div",{className:"Form-group"},m("label",null,"Facebook URL"),m("input",{className:"FormControl",type:"url",value:this.facebookUrl(),oninput:function(e){return t.facebookUrl(e.target.value)},placeholder:"https://facebook.com/username"})),m("div",{className:"Form-group"},m("label",null,"X (Twitter) URL"),m("input",{className:"FormControl",type:"url",value:this.xUrl(),oninput:function(e){return t.xUrl(e.target.value)},placeholder:"https://x.com/username"})),m("div",{className:"Form-group"},m("label",null,"Instagram URL"),m("input",{className:"FormControl",type:"url",value:this.instagramUrl(),oninput:function(e){return t.instagramUrl(e.target.value)},placeholder:"https://instagram.com/username"})),m("div",{className:"Form-group"},m(y(),{state:this.isVisible(),onchange:this.isVisible},"プロフィールを他のユーザーに公開する")),m("div",{className:"Form-group"},m(p(),{className:"Button Button--primary",type:"submit",loading:this.loading},"保存"),m(p(),{className:"Button Button--default",onclick:this.hide.bind(this)},"キャンセル"))))},r.renderCustomField=function(t){var e=this.customFields[t.name()];return e?m("div",{key:t.id(),className:"Form-group"},m("label",null,t.label(),t.required()&&m("span",{className:"required"},"*")),"textarea"===t.type()?m("textarea",{className:"FormControl",value:e(),oninput:function(t){return e(t.target.value)},rows:"4",placeholder:t.label()+"を入力してください",required:t.required()}):m("input",{className:"FormControl",type:"text",value:e(),oninput:function(t){return e(t.target.value)},placeholder:t.label()+"を入力してください",required:t.required()})):null},r.onsubmit=function(t){var e=this;t.preventDefault();for(var r,i=k(this.fields);!(r=i()).done;){var o=r.value;if(o.required()&&o.isActive()){var n=this.customFields[o.name()];if(!n||!n().trim())return void alert(o.label()+"は必須項目です。")}}this.loading=!0,m.redraw();for(var a,s={},l=k(this.fields);!(a=l()).done;){var u=a.value,c=this.customFields[u.name()];c&&(s[u.name()]=c())}var d={userId:app.session.user.id(),facebookUrl:this.facebookUrl(),xUrl:this.xUrl(),instagramUrl:this.instagramUrl(),isVisible:this.isVisible(),customFields:s};app.store.createRecord("user-profiles").save(d).then(function(t){app.store.pushObject(t),e.attrs.onSave&&e.attrs.onSave(t),e.hide(),m.redraw()}).catch(function(){e.loading=!1,m.redraw()})},e}(b()),A=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var r=e.prototype;return r.oninit=function(e){t.prototype.oninit.call(this,e),this.user=this.attrs.user,this.profile=null,this.fields=[],this.socialLinks=[],this.loading=!0,this.fieldsLoading=!0,this.socialLinksLoading=!0,this.loadProfile(),this.loadFields(),this.loadSocialLinks()},r.loadProfile=function(){var t=this;app.store.find("user-profiles",{userId:this.user.id()}).then(function(e){t.profile=e,t.loading=!1,m.redraw()}).catch(function(){t.loading=!1,m.redraw()})},r.loadFields=function(){var t=this;app.store.find("profile-fields").then(function(e){t.fields=e.sort(function(t,e){return t.sortOrder()-e.sortOrder()}),t.fieldsLoading=!1,m.redraw()}).catch(function(){t.fieldsLoading=!1,m.redraw()})},r.loadSocialLinks=function(){var t=this;app.store.find("social-links").then(function(e){t.socialLinks=e.sort(function(t,e){return t.sortOrder()-e.sortOrder()}),t.socialLinksLoading=!1,m.redraw()}).catch(function(){t.socialLinksLoading=!1,m.redraw()})},r.refreshProfile=function(t){this.profile=t,m.redraw()},r.view=function(){var t=this;if(this.loading||this.fieldsLoading||this.socialLinksLoading)return m("div",{className:"UserProfileWidget"},"読み込み中...");var e=app.session.user&&app.session.user.id()===this.user.id(),r=this.profile&&(this.profile.isVisible()||e||app.session.user&&app.session.user.isAdmin());return m("div",{className:"UserProfileWidget"},m("div",{className:"UserProfileWidget-header"},m("h3",null,"プロフィール"),e&&m(p(),{className:"Button Button--primary Button--small",onclick:function(){return app.modal.show(L,{profile:t.profile,onSave:function(e){return t.refreshProfile(e)}})}},"編集")),r&&this.profile?m("div",{className:"UserProfileWidget-content"},this.renderCustomFields(),this.renderSocialLinks(),!this.profile.isVisible()&&e&&m("div",{className:"UserProfileWidget-section"},m("em",null,"このプロフィールは非公開に設定されています。"))):m("div",{className:"UserProfileWidget-content"},e?m("div",{className:"UserProfileWidget-empty"},m("p",null,"プロフィールが設定されていません。"),m(p(),{className:"Button Button--primary",onclick:function(){return app.modal.show(L,{profile:null,onSave:function(e){return t.refreshProfile(e)}})}},"プロフィールを作成")):m("div",{className:"UserProfileWidget-empty"},m("p",null,"プロフィールは非公開に設定されています。"))))},r.renderCustomFields=function(){if(!this.profile||!this.profile.customFields)return null;var t=this.profile.customFields();return this.fields.filter(function(e){return e.isActive()&&t&&t[e.name()]}).map(function(e){return m("div",{key:e.id(),className:"UserProfileWidget-section"},m("h4",null,e.label()),m("p",null,t[e.name()]))})},r.renderSocialLinks=function(){if(!this.profile)return null;var t={facebook:this.profile.facebookUrl(),x:this.profile.xUrl(),instagram:this.profile.instagramUrl()};return Object.values(t).some(function(t){return t})?m("div",{className:"UserProfileWidget-section"},m("h4",null,"ソーシャルリンク"),m("div",{className:"UserProfileWidget-socialLinks"},this.socialLinks.filter(function(e){return t[e.name()]&&e.isActive()}).map(function(e){var r=t[e.name()];return m("a",{key:e.id(),href:r,target:"_blank",rel:"noopener noreferrer",className:"UserProfileWidget-socialLink",title:e.label()},m("img",{src:e.iconUrl(),alt:e.label(),className:"UserProfileWidget-socialIcon"}))}))):null},e}(d());const P=flarum.core.compat["common/extend"],O=flarum.core.compat["forum/components/UserPage"];var w=t.n(O);r().initializers.add("junya-user-profile",function(){r().store.models["user-profiles"]=s,r().store.models["profile-fields"]=l,r().store.models["social-links"]=u,(0,P.extend)(w().prototype,"sidebarItems",function(t){t.add("userProfile",m(A,{user:this.user}),10)})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map